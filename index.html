<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="appTitle">Krishi Sathi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- Message Box (Custom Alert) -->
    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-lg text-center">
            <p id="messageText" class="text-gray-800 text-lg font-medium"></p>
            <button onclick="hideMessage()" class="mt-4 px-6 py-2 bg-green-600 text-white font-semibold rounded-full hover:bg-green-700 transition-colors">OK</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="w-full max-w-md bg-white rounded-3xl overflow-hidden shadow-xl my-4 flex flex-col min-h-[80vh]">

        <!-- Dynamic Content Header -->
        <header id="dynamicHeader" class="bg-green-700 text-white p-4 sm:p-6 flex items-center rounded-t-3xl shadow-lg">
            <button id="backButton" onclick="renderPage('home')" class="mr-4 text-white hover:text-green-200 transition-colors hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </button>
            <h1 class="text-2xl sm:text-3xl font-bold" id="headerTitle">Krishi Sathi</h1>
            <div class="relative ml-auto">
                <select id="languageSelector" onchange="changeLanguage()" class="bg-green-800 text-white rounded-lg p-2 text-sm appearance-none cursor-pointer">
                    <option value="en">English</option>
                    <option value="hi">हिन्दी</option>
                    <option value="ml">മലയാളം</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                </div>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="appContent" class="flex-grow flex flex-col p-4 sm:p-6">
            <!-- Content will be rendered here by JavaScript -->
        </div>
    </div>

    <script>
        const translations = {
            en: {
                appTitle: 'Krishi Sathi',
                homeTitle: 'Krishi Sathi',
                welcomeHeading: 'Welcome, Farmer!',
                welcomeMessage: 'How can I help you today?',
                cropTitle: 'Crop Recommendation',
                cropDescription: 'Find the best crops for your land.',
                cropButton: 'Get Recommendation',
                weatherTitle: 'Weather Forecast',
                weatherDescription: 'Stay ahead with daily alerts.',
                weatherButton: 'Get Forecast',
                diseaseTitle: 'Disease Identification',
                diseaseDescription: 'Identify diseases from a photo.',
                diseaseButton: 'Identify Disease',
                chatTitle: 'Personal Chat',
                chatDescription: 'Chat with our agri-experts for help.',
                chatButton: 'Open Chat',
                chatInputPlaceholder: 'Type your message...',
                sendButton: 'Send',
                cropPageTitle: 'Crop Recommendation',
                cropPageSubtitle: 'Enter your soil details to get started.',
                phLabel: 'Soil pH',
                humidityLabel: 'Humidity (%)',
                moistureLabel: 'Moisture (%)',
                npkLabel: 'NPK (Nitrogen, Phosphorus, Potassium)',
                recommendButton: 'Recommend Crop',
                weatherPageTitle: 'Weather Forecast',
                weatherPageSubtitle: 'Daily updates and alerts',
                weatherForecastMessage: 'Forecast for today: Partly cloudy. No heavy rainfall or storm alerts at this time. Expect a high of 28°C and a low of 20°C.',
                weatherAlertMessage: '⚠ Alert: Possibility of heavy rainfall and thunderstorms in your area in the next 24 hours. Please take necessary precautions.',
                diseasePageTitle: 'Disease Identification',
                diseasePageSubtitle: 'Upload a photo or describe the symptoms.',
                uploadPhoto: 'Upload Photo',
                describeSymptoms: 'Describe Symptoms',
                submitButton: 'Submit',
                chatPageTitle: 'Personal Chat',
                chatPageSubtitle: 'Ask your farming questions here.',
                cropResultTitle: 'Recommended Crops',
                diseaseResultTitle: 'Possible Diagnosis',
                cropRecommended: 'Based on your inputs, we recommend the following crops: ',
                chatWelcome: 'Hello! I am your personal agri-expert chatbot. How can I help you today?',
                chatResponses: {
                    default: "I'm sorry, I don't understand that. You can ask me about crops, weather, or diseases.",
                    hello: "Hello! How can I assist you with your farming today?",
                    crop: "You can find personalized crop recommendations on the 'Crop Recommendation' page. Just enter your soil details there.",
                    weather: "For the latest weather forecast, please visit the 'Weather Forecast' page. Stay updated on heavy rainfall alerts!",
                    disease: "If your plant is sick, describe the symptoms on the 'Disease Identification' page, and I will try to help.",
                    ph: "The pH value of soil affects nutrient availability. A pH between 6.0 and 7.0 is optimal for most crops.",
                    npk: "NPK stands for Nitrogen, Phosphorus, and Potassium, which are essential nutrients for plant growth."
                }
            },
            hi: {
                appTitle: 'कृषि साथी',
                homeTitle: 'कृषि साथी',
                welcomeHeading: 'स्वागत है, किसान!',
                welcomeMessage: 'मैं आपकी आज कैसे मदद कर सकता हूँ?',
                cropTitle: 'फसल की सिफारिश',
                cropDescription: 'अपनी भूमि के लिए सर्वोत्तम फसलें खोजें।',
                cropButton: 'सिफारिश प्राप्त करें',
                weatherTitle: 'मौसम का पूर्वानुमान',
                weatherDescription: 'दैनिक अलर्ट के साथ आगे रहें।',
                weatherButton: 'पूर्वानुमान प्राप्त करें',
                diseaseTitle: 'रोग की पहचान',
                diseaseDescription: 'एक तस्वीर से रोगों की पहचान करें।',
                diseaseButton: 'रोग की पहचान करें',
                chatTitle: 'व्यक्तिगत चैट',
                chatDescription: 'हमारे कृषि-विशेषज्ञों से मदद लें।',
                chatButton: 'चैट खोलें',
                chatInputPlaceholder: 'अपना संदेश लिखें...',
                sendButton: 'भेजें',
                cropPageTitle: 'फसल की सिफारिश',
                cropPageSubtitle: 'शुरू करने के लिए अपनी मिट्टी का विवरण दर्ज करें।',
                phLabel: 'मिट्टी का पीएच (pH)',
                humidityLabel: 'नमी (%)',
                moistureLabel: 'नमी (%)',
                npkLabel: 'एनपीके (नाइट्रोजन, फास्फोरस, पोटेशियम)',
                recommendButton: 'फसल की सिफारिश करें',
                weatherPageTitle: 'मौसम का पूर्वानुमान',
                weatherPageSubtitle: 'दैनिक अपडेट और अलर्ट',
                weatherForecastMessage: 'आज का पूर्वानुमान: आंशिक रूप से बादल छाए रहेंगे। फिलहाल भारी बारिश या तूफान का कोई अलर्ट नहीं है। अधिकतम तापमान 28°C और न्यूनतम तापमान 20°C रहने की उम्मीद है।',
                weatherAlertMessage: '⚠ अलर्ट: अगले 24 घंटों में आपके क्षेत्र में भारी बारिश और गरज के साथ बारिश की संभावना है। कृपया आवश्यक सावधानी बरतें।',
                diseasePageTitle: 'रोग की पहचान',
                diseasePageSubtitle: 'एक फोटो अपलोड करें या लक्षणों का वर्णन करें।',
                uploadPhoto: 'फोटो अपलोड करें',
                describeSymptoms: 'लक्षणों का वर्णन करें',
                submitButton: 'जमा करें',
                chatPageTitle: 'व्यक्तिगत चैट',
                chatPageSubtitle: 'यहां अपने कृषि संबंधी प्रश्न पूछें।',
                cropResultTitle: 'अनुशंसित फसलें',
                diseaseResultTitle: 'संभावित निदान',
                cropRecommended: 'आपके इनपुट के आधार पर, हम निम्नलिखित फसलों की सिफारिश करते हैं: ',
                chatWelcome: 'नमस्ते! मैं आपका व्यक्तिगत कृषि-विशेषज्ञ चैटबॉट हूँ। मैं आज आपकी क्या मदद कर सकता हूँ?',
                chatResponses: {
                    default: "क्षमा करें, मैं यह नहीं समझा। आप मुझसे फसलों, मौसम, या रोगों के बारे में पूछ सकते हैं।",
                    hello: "नमस्ते! आज मैं आपकी कृषि में कैसे मदद कर सकता हूँ?",
                    crop: "आप 'फसल की सिफारिश' पृष्ठ पर व्यक्तिगत फसल की सिफारिशें पा सकते हैं। बस वहां अपनी मिट्टी का विवरण दर्ज करें।",
                    weather: "नवीनतम मौसम पूर्वानुमान के लिए, कृपया 'मौसम का पूर्वानुमान' पृष्ठ पर जाएं। भारी बारिश के अलर्ट से अपडेट रहें!",
                    disease: "अगर आपका पौधा बीमार है, तो 'रोग की पहचान' पृष्ठ पर लक्षणों का वर्णन करें, और मैं मदद करने की कोशिश करूँगा।",
                    ph: "मिट्टी का पीएच मान पोषक तत्वों की उपलब्धता को प्रभावित करता है। 6.0 और 7.0 के बीच का पीएच अधिकांश फसलों के लिए इष्टतम है।",
                    npk: "एनपीके का मतलब नाइट्रोजन, फास्फोरस और पोटेशियम है, जो पौधे के विकास के लिए आवश्यक पोषक तत्व हैं।"
                }
            },
            ml: {
                appTitle: 'കൃഷി സാഥി',
                homeTitle: 'കൃഷി സാഥി',
                welcomeHeading: 'സ്വാഗതം, കർഷകരെ!',
                welcomeMessage: 'ഇന്ന് ഞാൻ നിങ്ങളെ എങ്ങനെ സഹായിക്കും?',
                cropTitle: 'വിള ശുപാർശ',
                cropDescription: 'നിങ്ങളുടെ ഭൂമിക്ക് ഏറ്റവും അനുയോജ്യമായ വിളകൾ കണ്ടെത്തുക.',
                cropButton: 'ശുപാർശ നേടുക',
                weatherTitle: 'കാലാവസ്ഥാ പ്രവചനം',
                weatherDescription: 'ദൈനംദിന അലേർട്ടുകൾക്കൊപ്പം മുന്നോട്ട് പോകുക.',
                weatherButton: 'പ്രവചനം നേടുക',
                diseaseTitle: 'രോഗം തിരിച്ചറിയൽ',
                diseaseDescription: 'ഒരു ഫോട്ടോയിൽ നിന്ന് രോഗങ്ങൾ തിരിച്ചറിയുക.',
                diseaseButton: 'രോഗം തിരിച്ചറിയുക',
                chatTitle: 'വ്യക്തിഗത ചാറ്റ്',
                chatDescription: 'ഞങ്ങളുടെ കാർഷിക വിദഗ്ദ്ധരുമായി സംസാരിക്കുക.',
                chatButton: 'ചാറ്റ് തുറക്കുക',
                chatInputPlaceholder: 'നിങ്ങളുടെ സന്ദേശം ടൈപ്പ് ചെയ്യുക...',
                sendButton: 'അയയ്ക്കുക',
                cropPageTitle: 'വിള ശുപാർശ',
                cropPageSubtitle: 'തുടങ്ങാൻ നിങ്ങളുടെ മണ്ണിന്റെ വിവരങ്ങൾ നൽകുക.',
                phLabel: 'മണ്ണിന്റെ pH',
                humidityLabel: 'ഈർപ്പം (%)',
                moistureLabel: 'ഈർപ്പം (%)',
                npkLabel: 'എൻപികെ (നൈട്രജൻ, ഫോസ്ഫറസ്, പൊട്ടാസ്യം)',
                recommendButton: 'വിള ശുപാർശ ചെയ്യുക',
                weatherPageTitle: 'കാലാവസ്ഥാ പ്രവചനം',
                weatherPageSubtitle: 'ദൈനംദിന അപ്‌ഡേറ്റുകളും അലേർട്ടുകളും',
                weatherForecastMessage: 'ഇന്നത്തെ പ്രവചനം: ഭാഗികമായി മേഘാവൃതമായിരിക്കും. ഇപ്പോൾ ശക്തമായ മഴയ്‌ക്കോ കൊടുങ്കാറ്റിനോ അലേർട്ടുകളില്ല. ഉയർന്ന താപനില 28°C-ഉം കുറഞ്ഞ താപനില 20°C-ഉം പ്രതീക്ഷിക്കുന്നു.',
                weatherAlertMessage: '⚠ അലേർട്ട്: അടുത്ത 24 മണിക്കൂറിനുള്ളിൽ നിങ്ങളുടെ പ്രദേശത്ത് ശക്തമായ മഴയ്ക്കും ഇടിമിന്നലിനും സാധ്യതയുണ്ട്. ആവശ്യമായ മുൻകരുതലുകൾ എടുക്കുക.',
                diseasePageTitle: 'രോഗം തിരിച്ചറിയൽ',
                diseasePageSubtitle: 'ഒരു ഫോട്ടോ അപ്‌ലോഡ് ചെയ്യുക അല്ലെങ്കിൽ ലക്ഷണങ്ങൾ വിവരിക്കുക.',
                uploadPhoto: 'ഫോട്ടോ അപ്‌ലോഡ് ചെയ്യുക',
                describeSymptoms: 'ലക്ഷണങ്ങൾ വിവരിക്കുക',
                submitButton: 'സമർപ്പിക്കുക',
                chatPageTitle: 'വ്യക്തിഗത ചാറ്റ്',
                chatPageSubtitle: 'നിങ്ങളുടെ കൃഷി സംബന്ധമായ ചോദ്യങ്ങൾ ഇവിടെ ചോദിക്കുക.',
                cropResultTitle: 'ശുപാർശ ചെയ്ത വിളകൾ',
                diseaseResultTitle: 'സാധ്യമായ രോഗനിർണയം',
                cropRecommended: 'നിങ്ങളുടെ ഇൻപുട്ടുകൾ അടിസ്ഥാനമാക്കി, ഞങ്ങൾ ഇനിപ്പറയുന്ന വിളകൾ ശുപാർശ ചെയ്യുന്നു: ',
                chatWelcome: 'നമസ്കാരം! ഞാൻ നിങ്ങളുടെ വ്യക്തിഗത കാർഷിക വിദഗ്ദ്ധൻ ചാറ്റ്ബോട്ട് ആണ്. ഇന്ന് ഞാൻ നിങ്ങളെ എങ്ങനെ സഹായിക്കും?',
                chatResponses: {
                    default: "ക്ഷമിക്കണം, എനിക്ക് അത് മനസ്സിലായില്ല. നിങ്ങൾക്ക് വിളകൾ, കാലാവസ്ഥ, അല്ലെങ്കിൽ രോഗങ്ങൾ എന്നിവയെക്കുറിച്ച് എന്നോട് ചോദിക്കാം.",
                    hello: "നമസ്കാരം! ഇന്ന് നിങ്ങളുടെ കൃഷിയെ എങ്ങനെ സഹായിക്കും?",
                    crop: "'വിള ശുപാർശ' പേജിൽ നിങ്ങൾക്ക് വ്യക്തിഗത വിള ശുപാർശകൾ കണ്ടെത്താം. അവിടെ നിങ്ങളുടെ മണ്ണിന്റെ വിവരങ്ങൾ നൽകുക.",
                    weather: 'ഏറ്റവും പുതിയ കാലാവസ്ഥാ പ്രവചനത്തിനായി, ദയവായി "കാലാവസ്ഥാ പ്രവചനം" പേജ് സന്ദർശിക്കുക. ശക്തമായ മഴ മുന്നറിയിപ്പുകൾ ശ്രദ്ധിക്കുക!',
                    disease: "'രോഗം തിരിച്ചറിയൽ' പേജിൽ നിങ്ങളുടെ ചെടിയുടെ ലക്ഷണങ്ങൾ വിവരിക്കുക, ഞാൻ സഹായിക്കാൻ ശ്രമിക്കാം.",
                    ph: "മണ്ണിന്റെ പിഎച്ച് മൂല്യം പോഷകങ്ങളുടെ ലഭ്യതയെ ബാധിക്കുന്നു. 6.0-നും 7.0-നും ഇടയിലുള്ള പിഎച്ച് മിക്ക വിളകൾക്കും അനുയോജ്യമാണ്.",
                    npk: "എൻപികെ എന്നത് നൈട്രജൻ, ഫോസ്ഫറസ്, പൊട്ടാസ്യം എന്നിവയെ സൂചിപ്പിക്കുന്നു, ഇവ ചെടിയുടെ വളർച്ചയ്ക്ക് അത്യന്താപേക്ഷിതമായ പോഷകങ്ങളാണ്."
                }
            }
        };

        const appContent = document.getElementById('appContent');
        const headerTitle = document.getElementById('headerTitle');
        const backButton = document.getElementById('backButton');
        const languageSelector = document.getElementById('languageSelector');

        let currentLang = 'en';

        // Object to store the state of each page to prevent content from resetting on language change
        let pageStates = {
            chat: { messages: [] },
            crop: { recommendation: null },
            disease: { diagnosis: null }
        };

        const homePage = () => {
            const t = translations[currentLang];
            return `
                <div class="p-4 sm:p-6 text-center">
                    <div class="relative w-32 h-32 mx-auto rounded-full overflow-hidden shadow-lg border-4 border-white transform transition-transform duration-300 hover:scale-105">
                        <img src="https://placehold.co/400x400/22c55e/ffffff?text=FARMER" alt="A smiling farmer" class="object-cover w-full h-full">
                    </div>
                    <h2 class="text-xl sm:text-2xl font-semibold mt-4 text-green-700">${t.welcomeHeading}</h2>
                    <p class="text-gray-600 mt-2 text-sm sm:text-base">${t.welcomeMessage}</p>
                </div>
                <!-- Main Cards Section -->
                <main class="grid grid-cols-1 sm:grid-cols-2 gap-4 p-4 sm:p-6 flex-grow">
                    <!-- Crop Recommendation Card -->
                    <div onclick="renderPage('crop')" class="card bg-lime-100 rounded-2xl p-4 flex flex-col items-center text-center transition-transform duration-200 hover:scale-105 cursor-pointer">
                        <span class="text-4xl" role="img" aria-label="sprout">&#x1F331;</span>
                        <h3 class="text-lg font-medium mt-2 text-gray-800">${t.cropTitle}</h3>
                        <p class="text-sm text-gray-600 mt-1">${t.cropDescription}</p>
                    </div>

                    <!-- Weather Forecast Card -->
                    <div onclick="renderPage('weather')" class="card bg-sky-100 rounded-2xl p-4 flex flex-col items-center text-center transition-transform duration-200 hover:scale-105 cursor-pointer">
                        <span class="text-4xl" role="img" aria-label="sun">&#x2600;&#xFE0F;</span>
                        <h3 class="text-lg font-medium mt-2 text-gray-800">${t.weatherTitle}</h3>
                        <p class="text-sm text-gray-600 mt-1">${t.weatherDescription}</p>
                    </div>

                    <!-- Disease Identification Card -->
                    <div onclick="renderPage('disease')" class="card bg-amber-100 rounded-2xl p-4 flex flex-col items-center text-center transition-transform duration-200 hover:scale-105 col-span-1 sm:col-span-2 cursor-pointer">
                        <span class="text-4xl" role="img" aria-label="microscope">&#x1F52C;</span>
                        <h3 class="text-lg font-medium mt-2 text-gray-800">${t.diseaseTitle}</h3>
                        <p class="text-sm text-gray-600 mt-1">${t.diseaseDescription}</p>
                    </div>
                    
                    <!-- Personal Chatbox Card -->
                    <div onclick="renderPage('chat')" class="card bg-indigo-100 rounded-2xl p-4 flex flex-col items-center text-center transition-transform duration-200 hover:scale-105 col-span-1 sm:col-span-2 cursor-pointer">
                        <span class="text-4xl" role="img" aria-label="chat bubble">&#x1F4AC;</span>
                        <h3 class="text-lg font-medium mt-2 text-gray-800">${t.chatTitle}</h3>
                        <p class="text-sm text-gray-600 mt-1">${t.chatDescription}</p>
                    </div>
                </main>
            `;
        };

        const cropPage = () => {
            const t = translations[currentLang];
            const resultHtml = pageStates.crop.recommendation ? `
                <div id="cropResult" class="w-full mt-6 bg-lime-200 rounded-xl p-4 text-left">
                    <h4 class="text-lg font-semibold text-lime-800 mb-2">${t.cropResultTitle}</h4>
                    <p class="text-gray-700">${t.cropRecommended}<span class="font-bold">${pageStates.crop.recommendation}</span></p>
                </div>
            ` : '';
            return `
                <div class="flex flex-col items-center text-center flex-grow p-4">
                    <h2 class="text-2xl font-semibold text-green-700">${t.cropPageTitle}</h2>
                    <p class="text-gray-600 mt-2 text-sm">${t.cropPageSubtitle}</p>
                    <div class="w-full mt-6 space-y-4">
                        <div class="flex flex-col text-left">
                            <label for="ph" class="text-sm font-medium text-gray-700">${t.phLabel}</label>
                            <input type="number" id="ph" class="mt-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div class="flex flex-col text-left">
                            <label for="humidity" class="text-sm font-medium text-gray-700">${t.humidityLabel}</label>
                            <input type="number" id="humidity" class="mt-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div class="flex flex-col text-left">
                            <label for="moisture" class="text-sm font-medium text-gray-700">${t.moistureLabel}</label>
                            <input type="number" id="moisture" class="mt-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div class="flex flex-col text-left">
                            <label for="npk" class="text-sm font-medium text-gray-700">${t.npkLabel}</label>
                            <input type="text" id="npk" class="mt-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                    <button id="recommendButton" class="mt-6 px-6 py-2 bg-green-600 text-white font-semibold rounded-full hover:bg-green-700 transition-colors">
                        ${t.recommendButton}
                    </button>
                    ${resultHtml}
                </div>
            `;
        };

        const weatherPage = () => {
            const t = translations[currentLang];
            return `
                <div class="flex flex-col items-center text-center flex-grow p-4">
                    <h2 class="text-2xl font-semibold text-green-700">${t.weatherPageTitle}</h2>
                    <p class="text-gray-600 mt-2 text-sm">${t.weatherPageSubtitle}</p>
                    <div class="w-full mt-6 bg-sky-100 rounded-2xl p-6 text-left">
                        <h3 class="text-xl font-medium text-gray-800 mb-2">Today's Forecast</h3>
                        <p class="text-gray-600 mb-4">${t.weatherForecastMessage}</p>
                        <div class="p-4 bg-red-100 text-red-700 rounded-lg border-l-4 border-red-500">
                            <p class="font-medium">${t.weatherAlertMessage}</p>
                        </div>
                    </div>
                </div>
            `;
        };

        const diseasePage = () => {
            const t = translations[currentLang];
            const resultHtml = pageStates.disease.diagnosis ? `
                <div id="diseaseResult" class="w-full mt-6 bg-amber-200 rounded-xl p-4 text-left">
                    <h4 class="text-lg font-semibold text-amber-800 mb-2">${t.diseaseResultTitle}</h4>
                    <p class="text-gray-700">${pageStates.disease.diagnosis}</p>
                </div>
            ` : '';
            return `
                <div class="flex flex-col items-center text-center flex-grow p-4">
                    <h2 class="text-2xl font-semibold text-green-700">${t.diseasePageTitle}</h2>
                    <p class="text-gray-600 mt-2 text-sm">${t.diseasePageSubtitle}</p>
                    <div class="w-full mt-6 space-y-4">
                        <button onclick="showMessage('${t.message1}')" class="w-full px-6 py-4 bg-amber-100 text-amber-800 font-semibold rounded-2xl transition-transform duration-200 hover:scale-105">
                            <span class="text-3xl">&#x1F4F8;</span>
                            <p class="mt-2 text-lg">${t.uploadPhoto}</p>
                        </button>
                        <textarea id="symptomsInput" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" rows="5" placeholder="${t.describeSymptoms}..."></textarea>
                    </div>
                    <button id="submitButton" class="mt-6 px-6 py-2 bg-green-600 text-white font-semibold rounded-full hover:bg-green-700 transition-colors">
                        ${t.submitButton}
                    </button>
                    ${resultHtml}
                </div>
            `;
        };

        const chatPage = () => {
            const t = translations[currentLang];
            const chatMessagesHtml = pageStates.chat.messages.map(msg => `
                <div class="flex flex-col my-2 ${msg.sender === 'user' ? 'items-end' : 'items-start'}">
                    <p class="p-3 rounded-lg text-gray-800 ${msg.sender === 'user' ? 'bg-green-200 rounded-br-none' : 'bg-gray-200 rounded-bl-none'}">
                        ${msg.text}
                    </p>
                </div>
            `).join('');

            return `
                <div class="flex flex-col flex-grow p-4 sm:p-6">
                    <h2 class="text-2xl font-semibold text-green-700 text-center">${t.chatPageTitle}</h2>
                    <p class="text-gray-600 mt-2 text-sm text-center">${t.chatPageSubtitle}</p>
                    <div id="chatMessages" class="bg-white h-48 sm:h-64 p-4 rounded-xl border border-gray-200 overflow-y-auto mb-4 mt-4 scroll-smooth flex-grow">
                        ${chatMessagesHtml}
                    </div>
                    <div class="flex">
                        <input type="text" id="chatInput" placeholder="${t.chatInputPlaceholder}" class="flex-grow rounded-full px-4 py-2 border border-gray-300 focus:outline-none focus:border-green-500">
                        <button id="sendButton" class="ml-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-full hover:bg-green-700 transition-colors">
                            ${t.sendButton}
                        </button>
                    </div>
                </div>
            `;
        };

        const pages = {
            home: { html: homePage, title: 'Krishi Sathi' },
            crop: { html: cropPage, title: 'Crop Recommendation' },
            weather: { html: weatherPage, title: 'Weather Forecast' },
            disease: { html: diseasePage, title: 'Disease Identification' },
            chat: { html: chatPage, title: 'Personal Chat' }
        };

        function renderPage(pageName) {
            const page = pages[pageName];
            if (page) {
                appContent.innerHTML = page.html();
                headerTitle.innerText = translations[currentLang][pageName + 'Title'] || page.title;
                backButton.classList.toggle('hidden', pageName === 'home');
                
                attachEventListeners(pageName);
            }
        }

        function attachEventListeners(pageName) {
            if (pageName === 'crop') {
                document.getElementById('recommendButton').addEventListener('click', recommendCrop);
            } else if (pageName === 'disease') {
                document.getElementById('submitButton').addEventListener('click', identifyDisease);
            } else if (pageName === 'chat') {
                document.getElementById('sendButton').addEventListener('click', sendMessage);
                document.getElementById('chatInput').addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
                if (pageStates.chat.messages.length === 0) {
                    setTimeout(() => {
                        appendMessage(translations[currentLang].chatWelcome, 'bot');
                    }, 500);
                }
            }
        }

        function changeLanguage() {
            currentLang = languageSelector.value;
            renderPage(getCurrentPage());
        }

        function getCurrentPage() {
            const pageElement = appContent.firstElementChild;
            if (!pageElement) return 'home';
            const pageTitle = pageElement.querySelector('h2');
            if (!pageTitle) return 'home';

            const englishTitle = pageTitle.innerText;
            for (const key in translations.en) {
                if (translations.en[key] === englishTitle) {
                    const pageName = key.replace('PageTitle', '');
                    if (pages.hasOwnProperty(pageName)) {
                        return pageName;
                    }
                }
            }
            return 'home';
        }

        function showMessage(text) {
            document.getElementById('messageText').innerText = text;
            document.getElementById('messageBox').classList.remove('hidden');
            document.getElementById('messageBox').classList.add('flex');
        }

        function hideMessage() {
            document.getElementById('messageBox').classList.add('hidden');
            document.getElementById('messageBox').classList.remove('flex');
        }

        // --- New Functionality Starts Here ---

        function recommendCrop() {
            const ph = parseFloat(document.getElementById('ph').value);
            const humidity = parseFloat(document.getElementById('humidity').value);
            const moisture = parseFloat(document.getElementById('moisture').value);
            const npk = document.getElementById('npk').value.trim().toLowerCase();

            let recommendation = "No specific crop recommendation found. Please consult a local expert.";
            let conditions = [];

            // Condition 1: High NPK for heavy feeders
            if (npk.includes('high') && (ph >= 6 && ph <= 7)) {
                recommendation = "Maize (Corn), Wheat, Sugarcane";
                conditions.push('High NPK, Optimal pH');
            }
            // Condition 2: Low NPK, good for legumes
            else if (npk.includes('low') && (ph >= 6 && ph <= 7.5)) {
                recommendation = "Beans, Peas, Lentils (Legumes are good for nitrogen fixation)";
                conditions.push('Low NPK, Optimal pH');
            }
            // Condition 3: High moisture for rice
            else if (moisture > 80 && humidity > 85) {
                recommendation = "Rice, Jute, Water Chestnut";
                conditions.push('High Moisture and Humidity');
            }
            // Condition 4: Versatile crops for moderate conditions
            else if (ph >= 6 && ph <= 8 && moisture > 40) {
                recommendation = "Potatoes, Tomatoes, Cucumbers";
                conditions.push('Moderate pH and Moisture');
            }
            // Default condition
            else {
                recommendation = "General purpose crops like Cabbage or Spinach.";
                conditions.push('Default');
            }

            pageStates.crop.recommendation = recommendation;
            renderPage('crop');
        }

        function identifyDisease() {
            const symptoms = document.getElementById('symptomsInput').value.trim().toLowerCase();
            let diagnosis = "Unable to identify. Please describe the symptoms in more detail or upload a photo for expert analysis.";

            if (symptoms.includes('yellow') && symptoms.includes('leaf')) {
                if (symptoms.includes('veins')) {
                    diagnosis = "Possible Iron deficiency or other nutrient deficiency causing chlorosis.";
                } else if (symptoms.includes('spots') || symptoms.includes('blight')) {
                    diagnosis = "Possible Fungal or Bacterial Blight. Consider using a fungicide or bactericide.";
                } else {
                    diagnosis = "Possible Nitrogen deficiency or over-watering. Check soil moisture.";
                }
            } else if (symptoms.includes('brown') && symptoms.includes('spots')) {
                diagnosis = "Possible Leaf Spot disease (a common fungal infection). Remove affected leaves and apply fungicide.";
            } else if (symptoms.includes('wilting') || symptoms.includes('wilt')) {
                diagnosis = "Possible Bacterial Wilt or root rot. Check for poor drainage and root damage.";
            } else if (symptoms.includes('white') && (symptoms.includes('powder') || symptoms.includes('mold'))) {
                diagnosis = "Possible Powdery Mildew. Improve air circulation and apply a fungicide.";
            } else if (symptoms.includes('stunted') && symptoms.includes('growth')) {
                diagnosis = "Possible viral infection or severe nutrient deficiency. Isolate the plant to prevent spread.";
            }
            
            pageStates.disease.diagnosis = diagnosis;
            renderPage('disease');
        }

        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (message) {
                pageStates.chat.messages.push({ text: message, sender: 'user' });
                chatInput.value = '';
                
                let response = translations[currentLang].chatResponses.default;
                const lowerCaseMessage = message.toLowerCase();

                if (lowerCaseMessage.includes('hello') || lowerCaseMessage.includes('hi')) {
                    response = translations[currentLang].chatResponses.hello;
                } else if (lowerCaseMessage.includes('crop')) {
                    response = translations[currentLang].chatResponses.crop;
                } else if (lowerCaseMessage.includes('weather')) {
                    response = translations[currentLang].chatResponses.weather;
                } else if (lowerCaseMessage.includes('disease') || lowerCaseMessage.includes('sickness')) {
                    response = translations[currentLang].chatResponses.disease;
                } else if (lowerCaseMessage.includes('ph')) {
                    response = translations[currentLang].chatResponses.ph;
                } else if (lowerCaseMessage.includes('npk')) {
                    response = translations[currentLang].chatResponses.npk;
                }

                setTimeout(() => {
                    pageStates.chat.messages.push({ text: response, sender: 'bot' });
                    renderPage('chat');
                }, 1000);
            }
        }

        function appendMessage(text, sender) {
            pageStates.chat.messages.push({ text, sender });
            renderPage('chat');
        }

        // Initial render on page load
        window.onload = function() {
            renderPage('home');
        };
    </script>
</body>
</html>